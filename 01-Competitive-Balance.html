
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Competitive Balance in the NHL &#8212; Sports Analytics w/ Python</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Sports Analytics w/ Python" href="landing-page.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      <h1 class="site-logo" id="site-title">Sports Analytics w/ Python</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="landing-page.html">
   Sports Analytics w/ Python
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  NHL Case Studies
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Competitive Balance in the NHL
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  About Me
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference external" href="https://www.linkedin.com/in/bryan-clark-b38470b/">
   LinkedIn
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/01-Competitive-Balance.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        
        <a class="issues-button"
            href="https://github.com/bclark86/sports-analytics/issues/new?title=Issue%20on%20page%20%2F01-Competitive-Balance.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/bclark86/sports-analytics/master?urlpath=tree/01-Competitive-Balance.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#tl-dr">
   TL;DR
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#question">
     Question
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#approach">
     Approach
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#results">
     Results
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id1">
   Question
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pre-and-post-periods">
     Pre and Post Periods
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#competitive-balance">
     Competitive Balance
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#statistical-significance">
     Statistical Significance
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data">
   Data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#nhl-api-call">
     NHL API Call
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     Competitive Balance
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#analysis-periods">
     Analysis Periods
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exploration">
   Exploration
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#historical-competitive-balance">
     Historical Competitive Balance
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#expansion-era-vs-post-lockout">
     Expansion Era vs. Post-Lockout
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#modeling">
   Modeling
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#permutation-test">
     Permutation Test
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id3">
   Results
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="competitive-balance-in-the-nhl">
<h1>Competitive Balance in the NHL<a class="headerlink" href="#competitive-balance-in-the-nhl" title="Permalink to this headline">¶</a></h1>
<p>WORK-IN-PROGRESS</p>
<div class="section" id="tl-dr">
<h2>TL;DR<a class="headerlink" href="#tl-dr" title="Permalink to this headline">¶</a></h2>
<div class="section" id="question">
<h3>Question<a class="headerlink" href="#question" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>Did the 2004-2005 lockout, and subsequent changes, impact the competitive balance of the NHL for the better?</p>
</div></blockquote>
</div>
<div class="section" id="approach">
<h3>Approach<a class="headerlink" href="#approach" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>Compare 1979-2004 seasons (expansion eras) to the 2006-2021 seasons (post lockout) using within-season variance as a proxy for competitive balance and a permuation test for significant difference.</p>
</div></blockquote>
</div>
<div class="section" id="results">
<h3>Results<a class="headerlink" href="#results" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>Competitive balance significantly decreased from XX to YY (a relative improvement of Z%).</p>
</div></blockquote>
</div>
</div>
<div class="section" id="id1">
<h2>Question<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>Our goal of this analysis is to understand if the 2004-2005 lockout, and subsequent changes to the CBA and league rules, impacted the competitive balance of the NHL. We will tackle an important highlights of the pre and post periods for our analysis, how we will define competitive balance quantitatively, and if the difference between eras is statistically significant.</p>
<p>Ultimately, we want to answer the question:</p>
<blockquote>
<div><p>Did the 2004-2005 lockout, and subsequent changes, impact the competitive balance of the NHL for the better?</p>
</div></blockquote>
<div class="section" id="pre-and-post-periods">
<h3>Pre and Post Periods<a class="headerlink" href="#pre-and-post-periods" title="Permalink to this headline">¶</a></h3>
<p><strong>Expansion Eras: 1979-1980 to 2003-2004</strong></p>
<p>Major highlights.</p>
<p><strong>Post Lockout Era: 2005-2006 to 2020-2021</strong></p>
<p>Major rule changes.</p>
</div>
<div class="section" id="competitive-balance">
<h3>Competitive Balance<a class="headerlink" href="#competitive-balance" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Within-season variation</p></li>
<li><p>HHI (will this fail with teams moving in and out?)</p></li>
</ul>
</div>
<div class="section" id="statistical-significance">
<h3>Statistical Significance<a class="headerlink" href="#statistical-significance" title="Permalink to this headline">¶</a></h3>
<p>Permuation test</p>
</div>
</div>
<div class="section" id="data">
<h2>Data<a class="headerlink" href="#data" title="Permalink to this headline">¶</a></h2>
<p>We are querying the history of the NHL standings using a helper function that connects to the NHL stats API. There isn’t a ton of documentation, but this <a class="reference external" href="https://github.com/dword4/nhlapi">repo</a> is a great place to start for understanding what is available.</p>
<p>First we use a function to query the games played (GP) and point percentage for each team in a single season , and then we iterate through each season in history using that function to collect all historical results.</p>
<div class="section" id="nhl-api-call">
<h3>NHL API Call<a class="headerlink" href="#nhl-api-call" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>


<span class="k">def</span> <span class="nf">fetch_season_summary</span><span class="p">(</span><span class="n">season</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Query team standings for a given season.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># dictionary holder for the season</span>
    <span class="n">season_standings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="c1"># api request</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="s1">&#39;https://statsapi.web.nhl.com/api/v1/standings/byLeague&#39;</span>
    <span class="n">season_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;?season=</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">season</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">base_url</span> <span class="o">+</span> <span class="n">season_id</span><span class="p">)</span>
    <span class="c1"># throws an error for the missing lockout season</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">season_records</span> <span class="o">=</span> <span class="n">season</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;records&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># extract results</span>
        <span class="n">season_standings</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">season_records</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">]</span>
        <span class="n">season_standings</span><span class="p">[</span><span class="s1">&#39;num_teams&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">season_records</span><span class="p">[</span><span class="s1">&#39;teamRecords&#39;</span><span class="p">])</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[{</span>
            <span class="s1">&#39;team&#39;</span><span class="p">:</span> <span class="n">team</span><span class="p">[</span><span class="s1">&#39;team&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
            <span class="s1">&#39;gp&#39;</span><span class="p">:</span> <span class="n">team</span><span class="p">[</span><span class="s1">&#39;gamesPlayed&#39;</span><span class="p">],</span>
            <span class="s1">&#39;points&#39;</span><span class="p">:</span> <span class="n">team</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">],</span>
            <span class="s1">&#39;points_pct&#39;</span><span class="p">:</span> <span class="n">team</span><span class="p">[</span><span class="s1">&#39;pointsPercentage&#39;</span><span class="p">]</span>
        <span class="p">}</span> <span class="k">for</span> <span class="n">team</span> <span class="ow">in</span> <span class="n">season_records</span><span class="p">[</span><span class="s1">&#39;teamRecords&#39;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">season_standings</span><span class="p">[</span><span class="s1">&#39;standings_df&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">season_standings</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>


<span class="k">def</span> <span class="nf">fetch_season_history</span><span class="p">(</span><span class="n">start_season</span><span class="o">=</span><span class="s1">&#39;19171918&#39;</span><span class="p">,</span> <span class="n">end_season</span><span class="o">=</span><span class="s1">&#39;20202021&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Query team standings for every season between start_season and end_season</span>
<span class="sd">    (inclusive)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># convert to ints for incrementing after each loop</span>
    <span class="n">start_season_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start_season</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">start_season_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start_season</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:])</span>
    <span class="n">end_season_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">end_season</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">current_start</span> <span class="o">=</span> <span class="n">start_season_start</span>
    <span class="n">current_end</span> <span class="o">=</span> <span class="n">start_season_end</span>
    <span class="n">all_seasons</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start_season_start</span><span class="p">,</span> <span class="n">end_season_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="n">season</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_start</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_end</span><span class="p">)</span>
        <span class="n">season_dict</span> <span class="o">=</span> <span class="n">fetch_season_summary</span><span class="p">(</span><span class="n">season</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">season_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_seasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">season_dict</span><span class="p">)</span>
        <span class="n">current_start</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">current_end</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">all_seasons</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_seasons</span> <span class="o">=</span> <span class="n">fetch_season_history</span><span class="p">(</span><span class="s1">&#39;19171918&#39;</span><span class="p">,</span> <span class="s1">&#39;20202021&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 104/104 [00:06&lt;00:00, 16.24it/s]
</pre></div>
</div>
</div>
</div>
<p>The innagural NHL season was in 1917-1918 with four teams. We can see the results below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># list of dict for each season</span>
<span class="n">all_seasons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;season&#39;: &#39;19171918&#39;,
 &#39;num_teams&#39;: 4,
 &#39;standings_df&#39;:                      team  gp  points  points_pct
 0      Montréal Canadiens  22      26    0.590909
 1          Toronto Arenas  22      26    0.590909
 2  Ottawa Senators (1917)  22      18    0.409091
 3      Montreal Wanderers   6       2    0.166667}
</pre></div>
</div>
</div>
</div>
<p>Despite our progress bar showing 104 seasons, we only have 103 for analysis as the 2004-2005 season was lost due to a lockout.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total seasons: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_seasons</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Total seasons: 103
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id2">
<h3>Competitive Balance<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>There are two metrics we will use to analyze competitive balance:</p>
<ol class="simple">
<li><p>Within-season variation (regular season)</p></li>
<li><p>HHI (championships)</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">calculate_within_season_var</span><span class="p">(</span><span class="n">standings_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate competitive balance for the season. This assumes that the ideal</span>
<span class="sd">    point percentage is the average point percentage for the season, which may</span>
<span class="sd">    not be 0.5.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">actual_std</span> <span class="o">=</span> <span class="n">standings_df</span><span class="o">.</span><span class="n">points_pct</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># weighted average to account for differences in games played</span>
    <span class="n">point_pct_avg</span> <span class="o">=</span> <span class="n">standings_df</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">standings_df</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">gp</span> <span class="o">=</span> <span class="n">standings_df</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">ideal_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">point_pct_avg</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">point_pct_avg</span><span class="p">)))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">gp</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;gp&#39;</span><span class="p">:</span> <span class="n">gp</span><span class="p">,</span>
        <span class="s1">&#39;point_pct_avg&#39;</span><span class="p">:</span> <span class="n">point_pct_avg</span><span class="p">,</span>
        <span class="s1">&#39;actual_std&#39;</span><span class="p">:</span> <span class="n">actual_std</span><span class="p">,</span>
        <span class="s1">&#39;ideal_std&#39;</span><span class="p">:</span> <span class="n">ideal_std</span><span class="p">,</span>
        <span class="s1">&#39;ratio&#39;</span><span class="p">:</span> <span class="n">actual_std</span> <span class="o">/</span> <span class="n">ideal_std</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>For each iteration in the list comprehension, we extract the season label and then unpack the competitive balance dictionary result. The results for each season are stored as a pandas dataframe.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">competitive_balance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span>
    <span class="p">{</span>
        <span class="s1">&#39;season&#39;</span><span class="p">:</span> <span class="n">season</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">],</span>
        <span class="s1">&#39;num_teams&#39;</span><span class="p">:</span> <span class="n">season</span><span class="p">[</span><span class="s1">&#39;num_teams&#39;</span><span class="p">],</span>
        <span class="o">**</span><span class="n">calculate_within_season_var</span><span class="p">(</span><span class="n">season</span><span class="p">[</span><span class="s1">&#39;standings_df&#39;</span><span class="p">])</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">season</span> <span class="ow">in</span> <span class="n">all_seasons</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">competitive_balance_df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 103 entries, 0 to 102
Data columns (total 7 columns):
 #   Column         Non-Null Count  Dtype  
---  ------         --------------  -----  
 0   season         103 non-null    object 
 1   num_teams      103 non-null    int64  
 2   gp             103 non-null    float64
 3   point_pct_avg  103 non-null    float64
 4   actual_std     103 non-null    float64
 5   ideal_std      103 non-null    float64
 6   ratio          103 non-null    float64
dtypes: float64(5), int64(1), object(1)
memory usage: 5.8+ KB
</pre></div>
</div>
</div>
</div>
<p>We can see the first few seasons had very little teams and games played.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">competitive_balance_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>season</th>
      <th>num_teams</th>
      <th>gp</th>
      <th>point_pct_avg</th>
      <th>actual_std</th>
      <th>ideal_std</th>
      <th>ratio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>19171918</td>
      <td>4</td>
      <td>18.0</td>
      <td>0.5</td>
      <td>0.174078</td>
      <td>0.117851</td>
      <td>1.477098</td>
    </tr>
    <tr>
      <th>1</th>
      <td>19181919</td>
      <td>3</td>
      <td>18.0</td>
      <td>0.5</td>
      <td>0.163551</td>
      <td>0.117851</td>
      <td>1.387777</td>
    </tr>
    <tr>
      <th>2</th>
      <td>19191920</td>
      <td>4</td>
      <td>24.0</td>
      <td>0.5</td>
      <td>0.222439</td>
      <td>0.102062</td>
      <td>2.179449</td>
    </tr>
    <tr>
      <th>3</th>
      <td>19201921</td>
      <td>4</td>
      <td>24.0</td>
      <td>0.5</td>
      <td>0.147314</td>
      <td>0.102062</td>
      <td>1.443376</td>
    </tr>
    <tr>
      <th>4</th>
      <td>19211922</td>
      <td>4</td>
      <td>24.0</td>
      <td>0.5</td>
      <td>0.125865</td>
      <td>0.102062</td>
      <td>1.233221</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The most recent seasons were cut short due to COVID-19 and had a higher average points percentage due to points for overtime losses.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">competitive_balance_df</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>season</th>
      <th>num_teams</th>
      <th>gp</th>
      <th>point_pct_avg</th>
      <th>actual_std</th>
      <th>ideal_std</th>
      <th>ratio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>98</th>
      <td>20162017</td>
      <td>30</td>
      <td>82.000000</td>
      <td>0.558740</td>
      <td>0.090735</td>
      <td>0.054833</td>
      <td>1.654746</td>
    </tr>
    <tr>
      <th>99</th>
      <td>20172018</td>
      <td>31</td>
      <td>82.000000</td>
      <td>0.558222</td>
      <td>0.092602</td>
      <td>0.054840</td>
      <td>1.688573</td>
    </tr>
    <tr>
      <th>100</th>
      <td>20182019</td>
      <td>31</td>
      <td>82.000000</td>
      <td>0.553304</td>
      <td>0.081895</td>
      <td>0.054901</td>
      <td>1.491679</td>
    </tr>
    <tr>
      <th>101</th>
      <td>20192020</td>
      <td>31</td>
      <td>69.806452</td>
      <td>0.557763</td>
      <td>0.084668</td>
      <td>0.059444</td>
      <td>1.424336</td>
    </tr>
    <tr>
      <th>102</th>
      <td>20202021</td>
      <td>31</td>
      <td>56.000000</td>
      <td>0.556164</td>
      <td>0.115598</td>
      <td>0.066392</td>
      <td>1.741138</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="analysis-periods">
<h3>Analysis Periods<a class="headerlink" href="#analysis-periods" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">assign_period</span><span class="p">(</span><span class="n">season</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">season</span> <span class="o">&lt;</span> <span class="s1">&#39;19791980&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;other&#39;</span>
    <span class="k">elif</span> <span class="n">season</span> <span class="o">&lt;</span> <span class="s1">&#39;20052006&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;expansion&#39;</span>   
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;post-lockout&#39;</span>
    
<span class="n">competitive_balance_df</span><span class="p">[</span><span class="s1">&#39;period&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">competitive_balance_df</span><span class="o">.</span><span class="n">season</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">assign_period</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Using our defined periods, we have 25 expansion era seasons and 16 post-lockout seasons.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;seasons&#39;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">season</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
        <span class="s1">&#39;teams&#39;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">num_teams</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="s1">&#39;point_pct_avg&#39;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">point_pct_avg</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="s1">&#39;ratio&#39;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">ratio</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>


<span class="n">competitive_balance_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;period&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>seasons</th>
      <th>teams</th>
      <th>point_pct_avg</th>
      <th>ratio</th>
    </tr>
    <tr>
      <th>period</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>expansion</th>
      <td>25.0</td>
      <td>24.120000</td>
      <td>0.505425</td>
      <td>1.856610</td>
    </tr>
    <tr>
      <th>other</th>
      <td>62.0</td>
      <td>8.258065</td>
      <td>0.500000</td>
      <td>1.846821</td>
    </tr>
    <tr>
      <th>post-lockout</th>
      <td>16.0</td>
      <td>30.250000</td>
      <td>0.558143</td>
      <td>1.535151</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
</div>
<div class="section" id="exploration">
<h2>Exploration<a class="headerlink" href="#exploration" title="Permalink to this headline">¶</a></h2>
<p>To facilitate plotting, we’ll extract the last 4 characters from the <code class="docutils literal notranslate"><span class="pre">season</span></code> variable to represent the year.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">competitive_balance_df</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">competitive_balance_df</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="historical-competitive-balance">
<h3>Historical Competitive Balance<a class="headerlink" href="#historical-competitive-balance" title="Permalink to this headline">¶</a></h3>
<p>First, we’ll take a look at how competitive balance has changed throughout the history of the leauge.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">plotnine</span> <span class="k">as</span> <span class="nn">p9</span>

<span class="n">historical_pl</span><span class="p">(</span>
    <span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">competitive_balance_df</span><span class="p">,</span> <span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;ratio&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_point</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_line</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_x_continuous</span><span class="p">(</span><span class="n">breaks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1920</span><span class="p">,</span> <span class="mi">2021</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_color_manual</span><span class="p">(</span>
        <span class="n">breaks</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;other&#39;</span><span class="p">,</span> <span class="s1">&#39;expansion&#39;</span><span class="p">,</span> <span class="s1">&#39;post-lockout&#39;</span><span class="p">],</span>
        <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;#999999&#39;</span><span class="p">,</span> <span class="s1">&#39;#FF9900&#39;</span><span class="p">,</span> <span class="s1">&#39;#333333&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">labs</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Competitive Balance Ratio&#39;</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Season&#39;</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Ratio&#39;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;Period&#39;</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">guides</span><span class="p">(</span>
        
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme_bw</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/01-Competitive-Balance_25_0.png" src="_images/01-Competitive-Balance_25_0.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ggplot: (8772941740990)&gt;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="expansion-era-vs-post-lockout">
<h3>Expansion Era vs. Post-Lockout<a class="headerlink" href="#expansion-era-vs-post-lockout" title="Permalink to this headline">¶</a></h3>
<p>Let’s zoom in on the two periods of interest.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">analysis_df</span> <span class="o">=</span> <span class="n">competitive_balance_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;season &gt; &quot;19781989&quot;&#39;</span><span class="p">)</span>

<span class="c1"># extract means</span>
<span class="n">expansion</span> <span class="o">=</span> <span class="n">analysis_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;period == &quot;expansion&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ratio</span><span class="o">.</span><span class="n">values</span>
<span class="n">post_lockout</span> <span class="o">=</span> <span class="n">analysis_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;period == &quot;post-lockout&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ratio</span><span class="o">.</span><span class="n">values</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Competitive Balance Ratio&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">25</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expansion: </span><span class="si">{</span><span class="n">expansion</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.2F</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">expansion</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s1">.2F</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Post-Lockout: </span><span class="si">{</span><span class="n">post_lockout</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.2F</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">post_lockout</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s1">.2F</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Competitive Balance Ratio
-------------------------
Expansion: 1.86 (0.30)
Post-Lockout: 1.54 (0.19)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">analysis_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">analysis_df</span><span class="p">,</span> <span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;ratio&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;period&#39;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_point</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_line</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_x_continuous</span><span class="p">(</span><span class="n">breaks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1920</span><span class="p">,</span> <span class="mi">2021</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_color_manual</span><span class="p">(</span>
        <span class="n">breaks</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;expansion&#39;</span><span class="p">,</span> <span class="s1">&#39;post-lockout&#39;</span><span class="p">],</span>
        <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;#FF9900&#39;</span><span class="p">,</span> <span class="s1">&#39;#333333&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">labs</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Competitive Balance Ratio&#39;</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Season&#39;</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Ratio&#39;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;Period&#39;</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
        <span class="s1">&#39;text&#39;</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="mi">1991</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="mf">2.2</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">expansion</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.2F</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
        <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#FF9900&#39;</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
        <span class="s1">&#39;text&#39;</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="mi">2015</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="mf">1.9</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">post_lockout</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.2F</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
        <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#333333&#39;</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme_bw</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">analysis_plot</span><span class="o">.</span><span class="n">draw</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/01-Competitive-Balance_29_0.png" src="_images/01-Competitive-Balance_29_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="modeling">
<h2>Modeling<a class="headerlink" href="#modeling" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://matthew-brett.github.io/cfd2019/chapters/05/permutation_and_t_test">https://matthew-brett.github.io/cfd2019/chapters/05/permutation_and_t_test</a></p>
<ul class="simple">
<li><p>Permuatation test for within-season variance</p></li>
<li><p>permuation test for HHI</p></li>
</ul>
<ol class="simple">
<li><p>Function to calculate metric (HHI only)</p></li>
<li><p>Observed difference</p></li>
<li><p>Combine arrays</p></li>
<li><p>Permute and caculate</p></li>
<li><p>Analyze distribution</p></li>
</ol>
<div class="section" id="permutation-test">
<h3>Permutation Test<a class="headerlink" href="#permutation-test" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">observed_difference</span> <span class="o">=</span> <span class="n">post_lockout</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">expansion</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Observed Difference: </span><span class="si">{</span><span class="n">observed_difference</span><span class="si">:</span><span class="s1">.2F</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Observed Difference: -0.32
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">permutation_test</span><span class="p">(</span><span class="n">samples_a</span><span class="p">,</span> <span class="n">samples_b</span><span class="p">,</span> <span class="n">n_iters</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
    <span class="n">pooled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">samples_a</span><span class="p">,</span> <span class="n">samples_b</span><span class="p">)</span>
    <span class="n">random_differences</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_iters</span><span class="p">)</span>
    <span class="n">N_b</span> <span class="o">=</span> <span class="n">samples_b</span><span class="o">.</span><span class="n">size</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_iters</span><span class="p">):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">pooled</span><span class="p">)</span>
        <span class="n">random_differences</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pooled</span><span class="p">[:</span><span class="n">N_b</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pooled</span><span class="p">[</span><span class="n">N_b</span><span class="p">:])</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">difference</span><span class="o">=</span><span class="n">random_differences</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>

<span class="n">perm_test_df</span> <span class="o">=</span> <span class="n">permutation_test</span><span class="p">(</span><span class="n">expansion</span><span class="p">,</span> <span class="n">post_lockout</span><span class="p">)</span>

<span class="n">perm_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">perm_test_df</span><span class="p">,</span> <span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="s1">&#39;difference&#39;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_histogram</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;#CCCCCC&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="o">=</span><span class="n">observed_difference</span><span class="p">,</span> <span class="n">linetype</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
    <span class="o">+</span><span class="n">p9</span><span class="o">.</span><span class="n">labs</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Permuation Results&#39;</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Difference in Means (Null Hypothesis)&#39;</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="s1">&#39;# of Trials&#39;</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme_bw</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
        <span class="s1">&#39;text&#39;</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=-</span><span class="mf">0.3</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="mi">550</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Observed Difference&#39;</span><span class="p">,</span>
        <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#333333&#39;</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_segment</span><span class="p">(</span>
        <span class="n">x</span> <span class="o">=-</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="mi">525</span><span class="p">,</span> 
        <span class="n">xend</span><span class="o">=</span><span class="n">observed_difference</span><span class="o">+</span><span class="mf">0.025</span><span class="p">,</span>
        <span class="n">yend</span><span class="o">=</span><span class="mi">450</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
        <span class="n">arrow</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="n">angle</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">ends</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;open&#39;</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">perm_plot</span><span class="o">.</span><span class="n">draw</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/01-Competitive-Balance_34_0.png" src="_images/01-Competitive-Balance_34_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># two-sided test</span>
<span class="n">p_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">perm_test_df</span><span class="o">.</span><span class="n">difference</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">observed_difference</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Under the Null Hypothesis:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The probability of a difference as extreme or more is </span><span class="si">{</span><span class="n">p_val</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Under the Null Hypothesis:
The probability of a difference as extreme or more is 0.0006
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="id3">
<h2>Results<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>Summarize the findings</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "sports-analytics"
        },
        kernelOptions: {
            kernelName: "sports-analytics",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'sports-analytics'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="landing-page.html" title="previous page">Sports Analytics w/ Python</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Bryan Clark<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
<script async="" src="https://www.google-analytics.com/analytics.js"></script>
<script>
                        window.ga = window.ga || function () {
                            (ga.q = ga.q || []).push(arguments) };
                        ga.l = +new Date;
                        ga('create', 'UA-198853679-1', 'auto');
                        ga('set', 'anonymizeIp', true);
                        ga('send', 'pageview');
                    </script>

  </body>
</html>